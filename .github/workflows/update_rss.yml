name: Twitter RSS Generator

on:
  # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆè¿™æ˜¯æ™ºèƒ½è°ƒåº¦ï¼Œåªåœ¨æœ‰æ›´æ–°æ—¶æ‰æäº¤ï¼‰
  schedule:
    - cron: '*/30 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•æˆ–ç«‹å³æ›´æ–°ï¼‰
  workflow_dispatch:
    inputs:
      force:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰è´¦å·ï¼ˆå¿½ç•¥æ™ºèƒ½æ£€æµ‹ï¼‰'
        required: false
        default: false
        type: boolean
  
  # å½“accounts.txtæ–‡ä»¶å˜æ›´æ—¶ä¹Ÿè¿è¡Œ
  push:
    paths:
      - 'accounts.txt'
      - 'twitter_rss.py'
      - '.github/workflows/update_rss.yml'
    branches: [ main ]

# çŽ¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'

# æƒé™
permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è¶…æ—¶è®¾ç½®
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # ç¼“å­˜pipåŒ…
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install feedgen==1.0.0 beautifulsoup4==4.12.2 lxml==4.9.4 requests==2.31.0
      
      - name: ðŸ“ åˆ›å»ºfeedsç›®å½•
        run: |
          mkdir -p feeds
          mkdir -p feeds/state
      
      - name: ðŸ”„ è¿è¡ŒTwitter RSSç”Ÿæˆå™¨
        id: generate
        run: |
          # å¦‚æžœé€‰æ‹©äº†å¼ºåˆ¶æ›´æ–°
          if ${{ github.event.inputs.force == 'true' }}; then
            echo "ðŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
            python twitter_rss.py --force
          else
            echo "ðŸ¤– æ™ºèƒ½æ£€æµ‹æ¨¡å¼"
            python twitter_rss.py || true
          fi
      
      - name: ðŸ” æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        id: check-changes
        run: |
          # é…ç½®Git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ£€æŸ¥feedsç›®å½•å’Œurls.txtæ˜¯å¦æœ‰å˜åŒ–
          git add feeds/ urls.txt
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changes=æ— æ–‡ä»¶å˜æ›´" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # ç»Ÿè®¡å˜æ›´æ–‡ä»¶æ•°
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            echo "changes=æ£€æµ‹åˆ° $CHANGED_FILES ä¸ªæ–‡ä»¶å˜æ›´" >> $GITHUB_OUTPUT
            
            # åˆ—å‡ºå˜æ›´çš„æ–‡ä»¶
            git diff --cached --name-only | head -5 > changed_files.txt
            echo "changed_files=$(cat changed_files.txt)" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ’¾ æäº¤å˜æ›´åˆ°ä»“åº“
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          # èŽ·å–æ›´æ–°çš„è´¦å·æ•°é‡
          UPDATED_COUNT="${{ steps.generate.outputs.updated_count || 'æœªçŸ¥' }}"
          
          # æž„å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ðŸ”„ æ›´æ–° RSS Feeds"
          
          if [ "$UPDATED_COUNT" != "æœªçŸ¥" ]; then
            COMMIT_MSG="$COMMIT_MSG | æ›´æ–°è´¦å·: $UPDATED_COUNT"
          fi
          
          COMMIT_MSG="$COMMIT_MSG | æ—¶é—´: $COMMIT_TIME"
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "âœ… å·²æäº¤å˜æ›´åˆ°ä»“åº“"
          echo "ðŸ“ æäº¤ä¿¡æ¯: $COMMIT_MSG"
      
      - name: ðŸŽ¯ æ— å˜æ›´æ—¶è·³è¿‡
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "â­ï¸ æ™ºèƒ½æ£€æµ‹: æ— æ–°æŽ¨æ–‡ï¼Œè·³è¿‡æäº¤"
          echo ""
          echo "ðŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "  - æ£€æŸ¥è´¦å·æ•°: ${{ steps.generate.outputs.total_accounts || 'æœªçŸ¥' }}"
          echo "  - æ›´æ–°è´¦å·æ•°: ${{ steps.generate.outputs.updated_count || 0 }}"
          echo "  - è¿è¡Œæ—¶é—´: $(date)"
          echo ""
          echo "ðŸ’¡ ä¼˜åŒ–æ•ˆæžœ:"
          echo "  - èŠ‚çœäº†GitHub Actionsä½¿ç”¨æ—¶é—´"
          echo "  - å‡å°‘äº†ä¸å¿…è¦çš„ä»“åº“æäº¤"
          echo "  - ä¿æŒä»“åº“æ•´æ´"
      
      - name: ðŸ“‹ ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "# ðŸš€ Twitter RSS ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          if ${{ github.event.inputs.force == 'true' }}; then
            echo "- **è¿è¡Œæ¨¡å¼**: ðŸ”„ å¼ºåˆ¶æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **è¿è¡Œæ¨¡å¼**: ðŸ¤– æ™ºèƒ½æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ£€æŸ¥è´¦å·æ•°**: ${{ steps.generate.outputs.total_accounts || 'æœªçŸ¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ›´æ–°è´¦å·æ•°**: ${{ steps.generate.outputs.updated_count || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦æœ‰å˜æ›´**: ${{ steps.check-changes.outputs.has_changes || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å˜æ›´è¯¦æƒ…**: ${{ steps.check-changes.outputs.changes || 'æ— ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ”— ç”Ÿæˆçš„RSS URLs" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰RSS URLå¯åœ¨ [urls.txt](https://github.com/${{ github.repository }}/blob/main/urls.txt) ä¸­æŸ¥çœ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºå‰3ä¸ªURLä½œä¸ºç¤ºä¾‹
          echo "### ç¤ºä¾‹URLs:" >> $GITHUB_STEP_SUMMARY
          if [ -f "accounts.txt" ]; then
            count=0
            while read -r username && [ $count -lt 3 ]; do
              username=$(echo "$username" | tr -d '\r')
              if [[ -n "$username" && ! "$username" =~ ^# ]]; then
                echo "- **@$username**: \`https://raw.githubusercontent.com/${{ github.repository }}/main/feeds/$username.rss\`" >> $GITHUB_STEP_SUMMARY
                count=$((count + 1))
              fi
            done < accounts.txt
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "1. åœ¨ `accounts.txt` ä¸­æ·»åŠ Twitterç”¨æˆ·åï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "2. å·¥ä½œæµä¼šè‡ªåŠ¨ç”ŸæˆRSSæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "3. åœ¨n8nä¸­ä½¿ç”¨ç”Ÿæˆçš„URLï¼š\`https://raw.githubusercontent.com/ç”¨æˆ·å/twitter-rss-feeds/main/feeds/ç”¨æˆ·å.rss\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if ${{ steps.check-changes.outputs.has_changes == 'false' }}; then
            echo "## ðŸŽ¯ ä¼˜åŒ–æ•ˆæžœ" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æœ¬æ¬¡è¿è¡Œæ²¡æœ‰æ£€æµ‹åˆ°æŽ¨æ–‡æ›´æ–°ï¼Œè·³è¿‡äº†æäº¤ï¼ŒèŠ‚çœäº†GitHub Actionsä½¿ç”¨æ—¶é—´ï¼" >> $GITHUB_STEP_SUMMARY
          fi
